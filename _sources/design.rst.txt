=============================================
bamoni ハードウェア設計仕様書 (Circuit Design)
=============================================

:Author: bamoni Project Team
:Status: Draft
:Device: Seeed Studio XIAO ESP32C3

概要
====
本ドキュメントは、車両用バッテリー監視システム「bamoni」のハードウェア回路設計について記述する。
安全性と省電力性を最優先し、乾電池（ニッケル水素電池）駆動および高インピーダンス電圧測定回路を採用する。

電源回路構成
============
車両からの常時給電および充電は行わず、独立したニッケル水素電池（NiMH）4本による駆動とする。

設計方針
--------
* **安全性:** 車内高温環境下でのリチウムイオン電池（Li-Po）の使用を回避する。
* [cite_start]**充電ICの制約:** XIAO ESP32C3搭載の充電IC（ETA4054）はリチウムイオン専用（4.2V充電停止）であり、NiMHの充電には不適合であるため使用しない [cite: 1, 10, 16]。
* **保護:** USB接続時の電源逆流防止および、NiMH 4本直列時の過電圧（約5.8V）をXIAOの許容範囲（5Vピン）へ適合させるため、整流用ダイオードを使用する。

回路図 (Power)
--------------

.. code-block:: text

    [ Battery Box ]             [ Protection ]           [ MCU ]
    
    NiMH x 4 (Series)
    (approx. 4.8V - 5.8V)
          (+) --------------------|>|--------------------( 5V Pin )
                                Diode (1N4007)
                                Vf = ~0.7V drop
    
          (-) -------------------------------------------( GND Pin )

**部品選定:**

* **Diode:** 1N4007 (整流用ダイオード)
    * 目的1: 電圧降下（約0.7V）により、満充電時の5.8VをXIAOの安全圏（約5.1V）へ下げる。
    * 目的2: 開発時にUSBを接続した際、電池側への電流逆流（爆発・液漏れ）を防止する。

電圧測定回路構成
================
車両の鉛バッテリー（12V系）の電圧を測定するため、分圧回路を用いてESP32C3のADC入力範囲（0-3.0V程度）に変換する。

設計方針
--------
* **暗電流対策:** 常時接続となるため、高抵抗（合計122kΩ）を使用して消費電流を約0.1mAに抑える。
* **サージ対策:** オルタネーターノイズやロードダンプからGPIOを保護するため、ツェナーダイオードとコンデンサを配置する。

回路図 (Voltage Sensing)
------------------------

.. code-block:: text

    (Car Battery +)
           |
           |
          [R1]  100kΩ
           |
           +-----> Measure Point (To XIAO A0/D0 Pin)
           |
           +-----> [D1] Zener Diode (3.6V) -> GND (Overvoltage Protection)
           |
          [R2]  22kΩ
           |
           +-----> [C1] Capacitor (0.1uF - 1uF) -> GND (Noise Filter)
           |
    (Car Body GND)
           |
    (XIAO GND)  <-- Common GND Required

計算式
------

* **分圧比:**
  
  .. math::
  
     V_{out} = V_{in} \times \frac{R2}{R1 + R2} = V_{in} \times \frac{22}{122} \approx \frac{V_{in}}{5.545}

* **最大測定可能電圧:**
  ESP32のADC最大入力（減衰最大時）を約3.3Vとした場合:

  .. math::
  
     V_{max} = 3.3V \times \frac{122}{22} \approx 18.3V

  通常の車両電圧（12.0V - 14.4V）に対し十分なマージンを持つ。

実装上の注意
============
1. **GND共通化:** 電圧測定のため、電池駆動であってもXIAOのGNDを車両のボディアース（GND）に接続する必要がある。
2. **キャリブレーション:** 抵抗器の誤差（通常5%）を補正するため、実測値を用いたソフトウェア補正係数の調整を推奨する。